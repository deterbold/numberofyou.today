<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Number of You: Analytics Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Futura', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      color: white;
      padding: 2rem;
    }

    .header {
      text-align: center;
      margin-bottom: 3rem;
    }

    .header h1 {
      font-size: clamp(2rem, 5vw, 4rem);
      font-weight: bold;
      margin-bottom: 1rem;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    .header p {
      font-size: 1.2rem;
      opacity: 0.8;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      padding: 1.5rem;
      text-align: center;
      backdrop-filter: blur(10px);
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: #4CAF50;
    }

    .stat-label {
      font-size: 1rem;
      opacity: 0.8;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .chart-container {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      padding: 1.5rem;
      backdrop-filter: blur(10px);
    }

    .chart-title {
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 1rem;
      text-align: center;
    }

    .canvas-container {
      position: relative;
      height: 300px;
      margin-bottom: 1rem;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      font-size: 1.2rem;
      opacity: 0.7;
    }

    .error {
      background: rgba(255, 0, 0, 0.1);
      border: 1px solid rgba(255, 0, 0, 0.3);
      color: #ff6b6b;
      padding: 1rem;
      border-radius: 10px;
      margin: 1rem 0;
      text-align: center;
    }

    .color-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(30px, 1fr));
      gap: 5px;
      margin-top: 1rem;
      max-height: 200px;
      overflow-y: auto;
    }

    .color-square {
      width: 30px;
      height: 30px;
      border-radius: 3px;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .refresh-btn {
      background: rgba(76, 175, 80, 0.2);
      border: 2px solid #4CAF50;
      color: white;
      font-family: 'Futura', sans-serif;
      font-size: 1rem;
      padding: 0.8rem 2rem;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      margin: 1rem auto;
      display: block;
    }

    .refresh-btn:hover {
      background: rgba(76, 175, 80, 0.3);
      transform: translateY(-2px);
    }

    @media (max-width: 768px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }
      
      .canvas-container {
        height: 250px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Number of You: Analytics</h1>
    <p>Data visualization and trends from user sessions</p>
  </div>

  <div id="loadingMessage" class="loading">
    Loading analytics data...
  </div>

  <div id="dashboardContent" style="display: none;">
    <!-- Statistics Overview -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalSessions">0</div>
        <div class="stat-label">Total Sessions</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="avgRandomNumber">0</div>
        <div class="stat-label">Avg Random Number</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="avgAge">0</div>
        <div class="stat-label">Average Age</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="dataCompleteness">0%</div>
        <div class="stat-label">Data Completeness</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
      <!-- Random Numbers Over Time -->
      <div class="chart-container">
        <div class="chart-title">Random Numbers Over Time</div>
        <div class="canvas-container">
          <canvas id="numbersTimeChart"></canvas>
        </div>
      </div>

      <!-- Sentiment Distribution -->
      <div class="chart-container">
        <div class="chart-title">Sentiment Distribution</div>
        <div class="canvas-container">
          <canvas id="sentimentChart"></canvas>
        </div>
      </div>

      <!-- Age Distribution -->
      <div class="chart-container">
        <div class="chart-title">Age Distribution</div>
        <div class="canvas-container">
          <canvas id="ageChart"></canvas>
        </div>
      </div>

      <!-- Mood Distribution -->
      <div class="chart-container">
        <div class="chart-title">Mood Distribution</div>
        <div class="canvas-container">
          <canvas id="moodChart"></canvas>
        </div>
      </div>

      <!-- Color Palette -->
      <div class="chart-container">
        <div class="chart-title">Generated Color Palette</div>
        <div id="colorPalette" class="color-grid"></div>
      </div>

      <!-- Sessions by Hour -->
      <div class="chart-container">
        <div class="chart-title">Sessions by Hour of Day</div>
        <div class="canvas-container">
          <canvas id="hourChart"></canvas>
        </div>
      </div>
    </div>

    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
      <button class="refresh-btn" onclick="loadDashboard()">Refresh Data</button>
      <button class="refresh-btn" onclick="window.location.href='closing-page.html'" style="background: rgba(76, 175, 80, 0.2); border-color: #4CAF50;">View Your Number</button>
    </div>
  </div>

  <div id="errorMessage" class="error" style="display: none;"></div>

  <script>
    let dashboardData = null;
    let charts = {};

    // Load and display dashboard data
    async function loadDashboard() {
      try {
        console.log("Loading dashboard data...");
        
        const response = await fetch('get-data.php');
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Failed to load data');
        }
        
        dashboardData = data;
        console.log("Dashboard data loaded:", data);
        
        // Hide loading, show content
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('errorMessage').style.display = 'none';
        document.getElementById('dashboardContent').style.display = 'block';
        
        // Update statistics
        updateStatistics(data);
        
        // Create charts
        createCharts(data);
        
      } catch (error) {
        console.error("Error loading dashboard:", error);
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('dashboardContent').style.display = 'none';
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('errorMessage').textContent = 'Error loading data: ' + error.message;
      }
    }

    // Update statistics cards
    function updateStatistics(data) {
      const sessions = data.sessions || [];
      
      document.getElementById('totalSessions').textContent = sessions.length;
      
      if (sessions.length > 0) {
        // Average random number
        const avgRandom = sessions.reduce((sum, s) => sum + (s.randomNumber || 0), 0) / sessions.length;
        document.getElementById('avgRandomNumber').textContent = Math.round(avgRandom);
        
        // Average age
        const validAges = sessions.filter(s => s.age && s.age > 0).map(s => s.age);
        const avgAge = validAges.length > 0 ? validAges.reduce((sum, age) => sum + age, 0) / validAges.length : 0;
        document.getElementById('avgAge').textContent = Math.round(avgAge);
        
        // Data completeness
        const completeData = sessions.filter(s => 
          s.dataCompleteness && 
          s.dataCompleteness.camera && 
          s.dataCompleteness.voice && 
          s.dataCompleteness.location
        ).length;
        const completeness = (completeData / sessions.length) * 100;
        document.getElementById('dataCompleteness').textContent = Math.round(completeness) + '%';
      }
    }

    // Create all charts
    function createCharts(data) {
      const sessions = data.sessions || [];
      
      // Clear existing charts
      Object.values(charts).forEach(chart => chart.destroy());
      charts = {};
      
      if (sessions.length === 0) {
        console.log("No sessions data available for charts");
        return;
      }
      
      createNumbersTimeChart(sessions);
      createSentimentChart(sessions);
      createAgeChart(sessions);
      createMoodChart(sessions);
      createColorPalette(sessions);
      createHourChart(sessions);
    }

    // Random numbers over time chart
    function createNumbersTimeChart(sessions) {
      const ctx = document.getElementById('numbersTimeChart').getContext('2d');
      
      if (sessions.length === 0) {
        return;
      }
      
      // Create simple labels and data points
      const labels = sessions.map((s, index) => `Session ${index + 1}`);
      const data = sessions.map(s => s.randomNumber || 0);
      
      charts.numbersTime = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Random Numbers',
            data: data,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: { color: 'white' },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            },
            y: {
              beginAtZero: true,
              max: 255,
              ticks: { color: 'white' },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            }
          },
          plugins: {
            legend: { labels: { color: 'white' } }
          }
        }
      });
    }

    // Sentiment distribution chart
    function createSentimentChart(sessions) {
      const ctx = document.getElementById('sentimentChart').getContext('2d');
      
      const sentimentRanges = [
        { label: 'Very Negative (0-0.2)', min: 0, max: 0.2, color: '#ff6b6b' },
        { label: 'Negative (0.2-0.4)', min: 0.2, max: 0.4, color: '#ffa726' },
        { label: 'Neutral (0.4-0.6)', min: 0.4, max: 0.6, color: '#ffee58' },
        { label: 'Positive (0.6-0.8)', min: 0.6, max: 0.8, color: '#66bb6a' },
        { label: 'Very Positive (0.8-1.0)', min: 0.8, max: 1.0, color: '#4caf50' }
      ];
      
      const counts = sentimentRanges.map(range => 
        sessions.filter(s => 
          s.sentimentScore >= range.min && s.sentimentScore < range.max
        ).length
      );
      
      charts.sentiment = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: sentimentRanges.map(r => r.label),
          datasets: [{
            data: counts,
            backgroundColor: sentimentRanges.map(r => r.color)
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: 'white' } }
          }
        }
      });
    }

    // Age distribution chart
    function createAgeChart(sessions) {
      const ctx = document.getElementById('ageChart').getContext('2d');
      
      const validSessions = sessions.filter(s => s.age && s.age > 0);
      const ageRanges = [
        { label: '0-20', min: 0, max: 20 },
        { label: '21-30', min: 21, max: 30 },
        { label: '31-40', min: 31, max: 40 },
        { label: '41-50', min: 41, max: 50 },
        { label: '51-60', min: 51, max: 60 },
        { label: '60+', min: 60, max: 150 }
      ];
      
      const counts = ageRanges.map(range => 
        validSessions.filter(s => s.age >= range.min && s.age <= range.max).length
      );
      
      charts.age = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ageRanges.map(r => r.label),
          datasets: [{
            label: 'Count',
            data: counts,
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { ticks: { color: 'white' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
            y: { ticks: { color: 'white' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
          },
          plugins: {
            legend: { labels: { color: 'white' } }
          }
        }
      });
    }

    // Mood distribution chart
    function createMoodChart(sessions) {
      const ctx = document.getElementById('moodChart').getContext('2d');
      
      const moodCounts = {};
      sessions.forEach(s => {
        if (s.mood) {
          moodCounts[s.mood] = (moodCounts[s.mood] || 0) + 1;
        }
      });
      
      charts.mood = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: Object.keys(moodCounts),
          datasets: [{
            data: Object.values(moodCounts),
            backgroundColor: [
              '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', 
              '#ffeaa7', '#dda0dd', '#98d8c8', '#f7dc6f'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: 'white' } }
          }
        }
      });
    }

    // Color palette visualization
    function createColorPalette(sessions) {
      const container = document.getElementById('colorPalette');
      container.innerHTML = '';
      
      sessions.forEach(s => {
        if (s.colorRGB) {
          const colorSquare = document.createElement('div');
          colorSquare.className = 'color-square';
          colorSquare.style.backgroundColor = `rgb(${s.colorRGB.red}, ${s.colorRGB.green}, ${s.colorRGB.blue})`;
          colorSquare.title = `RGB(${s.colorRGB.red}, ${s.colorRGB.green}, ${s.colorRGB.blue})`;
          container.appendChild(colorSquare);
        }
      });
    }

    // Sessions by hour chart
    function createHourChart(sessions) {
      const ctx = document.getElementById('hourChart').getContext('2d');
      
      const hourCounts = new Array(24).fill(0);
      sessions.forEach(s => {
        if (s.timeData && s.timeData.hour !== undefined) {
          hourCounts[s.timeData.hour]++;
        }
      });
      
      charts.hour = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Array.from({length: 24}, (_, i) => i + ':00'),
          datasets: [{
            label: 'Sessions',
            data: hourCounts,
            backgroundColor: 'rgba(153, 102, 255, 0.6)',
            borderColor: 'rgba(153, 102, 255, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { ticks: { color: 'white' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
            y: { ticks: { color: 'white' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
          },
          plugins: {
            legend: { labels: { color: 'white' } }
          }
        }
      });
    }

    // Load dashboard when page loads
    window.addEventListener('load', loadDashboard);
  </script>
</body>
</html>